name: Validate Tags

on:
  pull_request:
    paths:
      - 'environments/**/*.tf'

permissions:
  contents: read
  pull-requests: write

jobs:
  checkov-validate:
    name: Checkov Tag Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: FolarinOyenuga/checkov-tag-validator@main
        id: checkov
        with:
          terraform_directory: ./environments/tag-test-dev
          required_tags: |
            business-unit
            application
            owner
            is-production
            service-area
            environment-name
          soft_fail: false

      - name: Post Checkov Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          SUMMARY: ${{ steps.checkov.outputs.violations_summary }}
          PASSED: ${{ steps.checkov.outputs.passed }}
        with:
          script: |
            const summary = process.env.SUMMARY || '‚úÖ All resources have required tags';
            const passed = process.env.PASSED === 'true';
            const icon = passed ? '‚úÖ' : '‚ö†Ô∏è';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üè∑Ô∏è Checkov Tag Validation ${icon}\n\n${summary}`
            });

  opa-validate:
    name: OPA Tag Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: FolarinOyenuga/opa-tag-validator@main
        id: opa
        with:
          terraform_directory: ./environments/tag-test-dev
          required_tags: |
            business-unit
            application
            owner
            is-production
            service-area
            environment-name
          soft_fail: false

      - name: Post OPA Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          SUMMARY: ${{ steps.opa.outputs.violations_summary }}
          PASSED: ${{ steps.opa.outputs.passed }}
        with:
          script: |
            const summary = process.env.SUMMARY || '‚úÖ All resources have required tags';
            const passed = process.env.PASSED === 'true';
            const icon = passed ? '‚úÖ' : '‚ö†Ô∏è';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üè∑Ô∏è OPA Tag Validation ${icon}\n\n${summary}`
            });
